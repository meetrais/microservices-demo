<!--
 Copyright 2020 Google LLC

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

{{ define "header" }}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>
        {{ if $.is_cymbal_brand }}
        Cymbal Shops
        {{ else }}
        Online Boutique
        {{ end }}
    </title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB"
        crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Google+Symbols:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="{{ $.baseUrl }}/static/styles/styles.css">
    <link rel="stylesheet" type="text/css" href="{{ $.baseUrl }}/static/styles/cart.css">
    <link rel="stylesheet" type="text/css" href="{{ $.baseUrl }}/static/styles/order.css">
    <link rel="stylesheet" type="text/css" href="{{ $.baseUrl }}/static/styles/bot.css">
    {{ if $.is_cymbal_brand }}
    <link rel='shortcut icon' type='image/x-icon' href='{{ $.baseUrl }}/static/favicon-cymbal.ico' />
    {{ else }}
    <link rel='shortcut icon' type='image/x-icon' href='{{ $.baseUrl }}/static/favicon.ico' />
    {{ end }}
</head>

<body>
    <header>
        {{ if $.frontendMessage }}
        <div class="navbar">
            <div class="container d-flex justify-content-center">
                <div class="h-free-shipping">{{ $.frontendMessage }}</div>
            </div>
        </div>
        {{ end }}
        <div class="navbar sub-navbar">
            <div class="container d-flex justify-content-between">
                <a href="{{ $.baseUrl }}/" class="navbar-brand d-flex align-items-center">
                    {{ if $.is_cymbal_brand }}
                    <img src="{{ $.baseUrl }}/static/icons/Cymbal_NavLogo.svg" alt="" class="top-left-logo-cymbal" />
                    {{ else }}
                    <img src="{{ $.baseUrl }}/static/icons/Hipster_NavLogo.svg" alt="" class="top-left-logo" />
                    {{ end }}
                </a>
                <div class="controls">

                    {{ if $.show_currency }}
                    <div class="h-controls">
                        <div class="h-control">
                            <span class="icon currency-icon"> {{ renderCurrencyLogo $.user_currency}}</span>
                            <form method="POST" class="controls-form" action="{{ $.baseUrl }}/setCurrency" id="currency_form" >
                                <select name="currency_code" onchange="document.getElementById('currency_form').submit();">
                                        {{range $.currencies}}
                                    <option value="{{.}}" {{if eq . $.user_currency}}selected="selected"{{end}}>{{.}}</option>
                                    {{end}}
                                </select>
                            </form>
                            <img src="{{ $.baseUrl }}/static/icons/Hipster_DownArrow.svg" alt="" class="icon arrow" />
                        </div>
                    </div>
                    {{ end }}

                    {{ if $.assistant_enabled }}
                    <a href="#" class="chat-link" onclick="openChatModal(); return false;">
                      <img src="{{ $.baseUrl }}/static/icons/Hipster_ChatIcon.svg" style="width: 22px; height: 22px;" alt="Chat icon" class="logo" title="Chat Assistant" />
                    </a>
                    {{ end }}

                    <a href="{{ $.baseUrl }}/cart" class="cart-link">
                        <img src="{{ $.baseUrl }}/static/icons/Hipster_CartIcon.svg" alt="Cart icon" class="logo" title="Cart" />
                        {{ if $.cart_size }}
                        <span class="cart-size-circle">{{$.cart_size}}</span>
                        {{ end }}
                    </a>
                </div>
            </div>
        </div>

    </header>

    <!-- Chat Modal -->
    <div id="chat-modal-overlay" class="chat-modal-overlay" style="display: none;">
        <div class="chat-modal-container">
            <div class="chat-modal-header">
                <span class="chat-modal-title">Chat Assistant</span>
                <button class="chat-modal-close" onclick="closeChatModal()" aria-label="Close chat">&times;</button>
            </div>
            <div class="chat-modal-content">
                <div id="modal-bot-messages" class="bot-messages">
                    <p class="bot-message">
                        <span class="bot-message-text">Hi, I'm the Cymbal Shops assistant. I can help you with your shopping experience.</span>
                    </p>
                    <p class="bot-message">
                        <span class="bot-message-text">What can I help you with?</span>
                    </p>
                </div>
                <div class="bot-input">
                    <input id="modal-bot-input-text" type="text" style="margin-right: 30px;" class="bot-input-text" placeholder="Recommend me items...">
                    <input id="modal-bot-input-file" type="file" class="bot-input-file-button" onchange="getModalBase64()">
                    <button id="modal-bot-input-button" class="bot-input-button">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Modal state management
        let chatModalState = {
            isOpen: false,
            isInitialized: false
        };

        function openChatModal() {
            try {
                // Prevent multiple modal instances
                if (chatModalState.isOpen) {
                    return;
                }

                const modal = document.getElementById('chat-modal-overlay');
                if (modal) {
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden'; // Prevent background scrolling
                    chatModalState.isOpen = true;
                    
                    // Focus management - focus on modal container
                    const modalContainer = modal.querySelector('.chat-modal-container');
                    if (modalContainer) {
                        modalContainer.focus();
                    }
                    
                    // Initialize chat modal functionality will be added in next tasks
                    if (!chatModalState.isInitialized) {
                        initializeChatModal();
                        chatModalState.isInitialized = true;
                    }
                } else {
                    // Fallback to assistant page if modal not available
                    console.warn('Chat modal not found, redirecting to assistant page');
                    window.location.href = '{{ $.baseUrl }}/assistant';
                }
            } catch (error) {
                console.error('Failed to open chat modal:', error);
                window.location.href = '{{ $.baseUrl }}/assistant';
            }
        }

        function closeChatModal() {
            try {
                const modal = document.getElementById('chat-modal-overlay');
                if (modal && chatModalState.isOpen) {
                    modal.style.display = 'none';
                    document.body.style.overflow = ''; // Restore background scrolling
                    chatModalState.isOpen = false;
                    
                    // Return focus to the chat icon
                    const chatLink = document.querySelector('.chat-link');
                    if (chatLink) {
                        chatLink.focus();
                    }
                }
            } catch (error) {
                console.error('Failed to close chat modal:', error);
            }
        }

        // Modal chat functionality
        let modalImage;
        
        function getModalBase64() {
            const fileInput = document.getElementById('modal-bot-input-file');
            if (fileInput && fileInput.files[0]) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onloadend = function () {
                    modalImage = reader.result;
                    console.log('Modal image loaded:', modalImage);
                };
                reader.readAsDataURL(file);
            }
        }

        function extractIdsFromString(message) {
            const idPattern = /\[([a-zA-Z0-9-]+)\]/g;
            const matches = message.matchAll(idPattern);
            const ids = [];
            for (const match of matches) {
                ids.push(match[1]);
            }
            return ids;
        }

        function initializeChatModal() {
            console.log('Chat modal initialized');
            
            const modalBotMessages = document.getElementById("modal-bot-messages");
            const modalBotButton = document.getElementById("modal-bot-input-button");
            const modalBotInput = document.getElementById("modal-bot-input-text");

            if (!modalBotButton || !modalBotInput || !modalBotMessages) {
                console.error('Modal chat elements not found');
                return;
            }

            // Add event listeners
            modalBotButton.addEventListener("click", handleModalButtonClick);
            modalBotInput.addEventListener("keypress", (event) => {
                if (event.key === "Enter") {
                    modalBotButton.click();
                }
            });

            // Focus on input when modal opens
            modalBotInput.focus();
        }

        async function handleModalButtonClick() {
            const modalBotMessages = document.getElementById("modal-bot-messages");
            const modalBotButton = document.getElementById("modal-bot-input-button");
            const modalBotInput = document.getElementById("modal-bot-input-text");

            if (!modalBotInput.value || !modalBotInput.value.trim()) {
                return;
            }

            // Construct and render user message
            console.log("Modal bot button clicked");
            const message = modalBotInput.value;
            console.log("Modal message: " + message);
            
            const usermessage = document.createElement("p");
            const userMessageSpan = document.createElement("span");
            userMessageSpan.innerText = message;
            userMessageSpan.classList.add("user-message-text");
            usermessage.classList.add("user-message");
            usermessage.appendChild(userMessageSpan);
            modalBotMessages.appendChild(usermessage);

            // Add image if present
            if (modalImage) {
                const imageDivElement = document.createElement("div");
                imageDivElement.classList.add("user-image-div");
                const imageElement = document.createElement("img");
                imageElement.src = modalImage;
                imageElement.classList.add("user-image");
                imageElement.onerror = function() { this.style.display = 'none'; };
                imageDivElement.appendChild(imageElement);
                modalBotMessages.appendChild(imageDivElement);
            }

            modalBotMessages.scrollTo(0, modalBotMessages.scrollHeight);
            modalBotInput.value = "";

            // Disable send button and input field
            modalBotButton.disabled = true;
            modalBotInput.disabled = true;
            console.log("Modal bot is typing");

            // Construct and render placeholder bot message
            const botMessage = document.createElement("p");
            botMessage.classList.add("bot-message-loading");
            const botMessageSpan = document.createElement("span");
            botMessageSpan.innerText = "";
            botMessageSpan.classList.add("bot-message-text");
            botMessage.classList.add("bot-message");
            botMessage.appendChild(botMessageSpan);
            modalBotMessages.appendChild(botMessage);
            modalBotMessages.scrollTo(0, modalBotMessages.scrollHeight);

            try {
                // Request a response from the Shopping Assistant
                const response = await fetch("{{ $.baseUrl }}/bot", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        message: message,
                        image: modalImage
                    }),
                });
                const responseJson = await response.json();
                console.log('Modal bot response:', responseJson);

                // Fetch the product IDs from the response
                const extractedIds = extractIdsFromString(responseJson.message);
                console.log('Modal extracted IDs:', extractedIds);

                // Replace the placeholder bot message text with the real response
                botMessageSpan.innerText = responseJson.message.replace(/\n+[-*\d][\S\s]*/g, "");
                botMessage.classList.remove("bot-message-loading");

                // If there are any product IDs...
                if (extractedIds.length > 0) {
                    // Construct root products div
                    const botProductsDiv = document.createElement("div");
                    botProductsDiv.classList.add("bot-products");

                    // For each product...
                    for (const id of extractedIds) {
                        try {
                            // Retrieve product metadata from the Product Catalog
                            const productResponse = await fetch("{{ $.baseUrl }}/product-meta/" + id, {
                                method: "GET",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                            });
                            const product = await productResponse.json();

                            // Construct main product div
                            const botProductDiv = document.createElement("a");
                            botProductDiv.classList.add("bot-product");
                            botProductDiv.href = "{{ $.baseUrl }}/product/" + id;
                            
                            // Add click handler to close modal when product is clicked
                            botProductDiv.addEventListener('click', function() {
                                closeChatModal();
                            });

                            // Construct product image
                            const botProductImg = document.createElement("img");
                            botProductImg.src = product["picture"];
                            botProductImg.classList.add("bot-product-img");
                            botProductImg.onerror = function() { this.style.display = 'none'; };
                            botProductDiv.appendChild(botProductImg);

                            // Construct product description div
                            const botProductDescription = document.createElement("div");
                            botProductDescription.classList.add("bot-product-description");
                            let productDescription = product["description"];
                            if (productDescription.length > 350) {
                                productDescription = productDescription.substring(0, 330) + '...';
                            }
                            botProductDescription.innerHTML = "<b>" + product["name"] + "</b><br>" + productDescription;
                            botProductDiv.appendChild(botProductDescription);

                            // Append main product div into the root products div
                            botProductsDiv.appendChild(botProductDiv);
                        } catch (error) {
                            console.error('Error fetching product:', id, error);
                        }
                    }
                    // Render products
                    modalBotMessages.appendChild(botProductsDiv);
                }

                modalBotMessages.scrollTo(0, modalBotMessages.scrollHeight);

            } catch (error) {
                console.error('Error in modal chat:', error);
                botMessageSpan.innerText = "Sorry, I encountered an error. Please try again.";
                botMessage.classList.remove("bot-message-loading");
            }

            // Re-enable button and input field
            modalBotButton.disabled = false;
            modalBotInput.disabled = false;
            modalBotInput.focus();
            
            // Clear the image after sending
            modalImage = null;
            const fileInput = document.getElementById('modal-bot-input-file');
            if (fileInput) {
                fileInput.value = '';
            }
        }

        // Initialize modal event listeners when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('chat-modal-overlay');
            if (modal) {
                // Close modal when clicking outside of it (backdrop click)
                modal.addEventListener('click', function(event) {
                    if (event.target === modal) {
                        closeChatModal();
                    }
                });

                // Make modal container focusable for accessibility
                const modalContainer = modal.querySelector('.chat-modal-container');
                if (modalContainer) {
                    modalContainer.setAttribute('tabindex', '-1');
                }
            }

            // Close modal with Escape key
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' && chatModalState.isOpen) {
                    closeChatModal();
                }
            });

            // Prevent modal from closing when clicking inside the modal container
            const modalContainer = document.querySelector('.chat-modal-container');
            if (modalContainer) {
                modalContainer.addEventListener('click', function(event) {
                    event.stopPropagation();
                });
            }
        });
    </script>
    {{end}}
